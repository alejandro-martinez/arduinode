<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Clases.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Arduinode.html">Arduinode</a></li>
                                <li><a href="../classes/Dispositivo.html">Dispositivo</a></li>
                                <li><a href="../classes/Programador.html">Programador</a></li>
                                <li><a href="../classes/Tarea.html">Tarea</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Arduinode.html">Arduinode</a></li>
                                <li><a href="../modules/DataStore.html">DataStore</a></li>
                                <li><a href="../modules/Programador de Tareas.html">Programador de Tareas</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: Clases.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Representa un Dispositivo Arduino, y sus Salidas
 * Permite:
 * 1) accionar las salidas que posee, (Luces, Bombas, Persianas);
 * 2) Consultar lista de salidas y sus estados
 * @module
 */

//Dependencias
var socket 		= require(&#x27;./socket&#x27;)(),
	DateConvert = require(&#x27;./utils/DateConvert&#x27;)(),
	DataStore	= require(&#x27;./DataStore&#x27;),
	fs			= require(&#x27;fs&#x27;),
	_ 			= require(&#x27;underscore&#x27;);

/**
* Representa un Dispositivo Arduino
*
* @class Dispositivo
* @constructor
*/

/**
* Dirección IP del dispositivo Arduino
* @property ip
* @type String
*/
/**
* Descripción del dispositivo
* @property note
* @type String
*/
/**
* Lista de salidas (instancias de Salida) del dispositivo
* @property salidas
* @type Array
*/
function Dispositivo(_id, _ip, _note) {
	this.id_disp = _id || null;
	this.ip 	 = _ip || null;
	this.note 	 = _note || null;
	this.salidas = [];
}

Dispositivo.prototype = {
/**
* Devuelve una salida por Numero.
* @method getSalidaByNro
* @return Salida
*/
	getSalidaByNro: function(nro_salida) {
		var salida = _.findWhere(this.salidas, { nro_salida: parseInt(nro_salida) })
		salida.ip = this.ip;
		return salida;
	},
/**
* Ejecuta un comando sobre una salida de un dispositivo.
* @method accionarSalida
* @param params Objeto JSON con la clave IP del dispositivo, numero de salida, y comando
* @param callback Funcion callback que se ejecuta cuando se completa la operaciòn
* @return Boolean Resultado del comando
*/
	accionarSalida: function(params, callback) {
		var salida = this.getSalidaByNro( params.nro_salida );

		if (salida) {
			salida.switch( params ,function(response){
				callback(response);
			});
		}
	},
/**
* Parsea los datos recibidos desde los dispositivos Arduino
* @method parseSalida
* @param params Objeto JSON con la clave IP del dispositivo, numero de salida, y comando
* @param callback Funcion callback que se ejecuta cuando se completa la operaciòn
* @return Boolean Resultado del comando
*/
	parseSalida: function(params, _data ) {
		This = this;
		if (_data.length &gt; 0) {

			var parsed = [],
				salidasParsed = [];

			if (_data.indexOf(&quot;\n&quot;) &lt; 0) {
				salidasParsed.push(_data);
			}
			else {
				salidasParsed = _data.split(&quot;\n&quot;);
			}

			salidasParsed.forEach(function(str) {
				if (str.length) {
					var posGuion 	= str.indexOf(&quot;-&quot;),
						posDospuntos= str.indexOf(&quot;:&quot;),
						posPunto 	= str.indexOf(&quot;.&quot;),
						nro_salida 	= str[posGuion+1] + str[posGuion+2];

					if (posPunto &gt; -1) {
						var temporizada = DateConvert.min_a_horario(str.substr( posPunto + 1));
					}
					parsed.push({
						nro_salida	: parseInt(nro_salida),
						tipo		: str[0],
						ip			: params.ip,
						note		: This.getSalidaByNro(nro_salida).note || params.ip,
						estado		: parseInt( str[posDospuntos+1] ),
						temporizada	: temporizada
					});
				}
			});
			return parsed;
		}
	},
	getSalidasByEstado: function( _estado, _array ) {
		return _.where(_array, {estado: _estado});
	},
	getSalidas: function( params, callback ) {
		params.comando = &#x27;G&#x27;;
		var This = this;
		socket.send( params, function( response ) {
			callback( This.parseSalida( params, response ) );
		});
	},
	//Devuelve listado de salidas (y sus estados) de un dispositivo
	setSalidas: function( _salidas ) {
		var This = this;
		if (_salidas.length) {
			_salidas.forEach(function(s) {
				var factory = new SalidaFactory(),
					salida 	= factory.create( s.nro_salida,s.tipo, s.note );
				This.salidas.push( salida);
			});
		}
	},
	load: function() {
		DataStore.getFile(&#x27;dispositivos&#x27;);
	}
}

/**************** Clase Salida *******************

Representa un objeto Salida de la clase Dispositivo;

Las instancias se crean a través de SalidaFactory,
dependiento del atributo tipo;

El protocolo establece la siguiente sintaxis para enviar comandos
al dispositivo Arduino:

[Comando] [Nro de salida] [:] [Accion] [.] [Temporización]

donde:

	- Temporizacion [en minutos] es opcional

	- Accion [ 1,0 ] y  Temporizacion solo se usan cuando Comando = T

	- Comando: puede valer S, T, o P

		S sirve para consultar el estado de una salida
			Uso: S + Nro de Salida

		T sirve para setear el estado de la Salida
			Uso: T + Nro de Salida + Accion (1 o 0)
			Ejemplo:
					T231 --&gt; Apaga (OFF), a la salida numero 23
			Ejemplo Temporizacion:
					T230.60 --&gt; Activa la salida 23 por 60 (minutos)

		P sirve para accionar sobre Salidas tipo Persiana
			Uso: P + Nro de Salida + Accion (0,1,2)
				0 --&gt; Sube la Persiana
				1 --&gt; Baja
				2 --&gt; Detiene

			Ejemplo:
					P251 --&gt; Baja la persiana cuya salida es 25

//*************** Clase Dispositivo *****************/

function Salida( _nro_salida, _note, _tipo ) {
	this.nro_salida = _nro_salida || null;
	this.note 		= _note || null;
	this.tipo 		= _tipo || null;
	this.estado 	= null;
	this.accion 	= null;
	this.comando 	= null,
	this.temporizada= null;
}

/* Metodo switch general, interactua con el socket enviandole un comando */

Salida.prototype.switch = function( params, callback ) {
	if (params.hasOwnProperty(&#x27;comando&#x27;)) {
		socket.send( params, function( response, timeout ) {
			callback(response)
		});
	}
};

function Luz( nro_salida, _note ) {
	Salida.apply(this, [nro_salida, _note]);
	this.tipo 	 = &#x27;L&#x27;;
	this.comando = &#x27;T&#x27;;
};

/* Cada Tipo de Salida, reescribe su modo de hacer switch */

Luz.prototype.switch = function( params, callback ) {
	var comando = this.comando
				+ this.nro_salida
				+ params.estado
				+ &quot;.&quot;
				+ params.temporizada;
	var onSwitchResponse = function(response) {
		callback(response);
	}
	Salida.prototype.switch({ comando: comando, ip: this.ip}, onSwitchResponse);
};

function Persiana(nro_salida, _note) {
	Salida.apply(this,[nro_salida, _note]);
	this.tipo = this.comando = &#x27;P&#x27;;
};

Persiana.prototype.switch = function( params, callback ) {
	var comando = this.comando + this.nro_salida + params.estado,
		onSwitchResponse = function( response ) {
		callback(response);
	}
	Salida.prototype.switch({ comando: comando, ip: this.ip}, onSwitchResponse);
};

/* Factory para crear los distintos tipos de Salida */
function SalidaFactory() {
	this.create = function( nro_salida,_tipo, _note ) {
		if (_tipo === &quot;L&quot;) {
			return new Luz(nro_salida, _note);
		}
		else {
			return new Persiana(nro_salida,_note);
		}
	}
}
exports.Dispositivo = Dispositivo;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
