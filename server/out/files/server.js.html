<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>server.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Arduinode.html">Arduinode</a></li>
                                <li><a href="../classes/Dispositivo.html">Dispositivo</a></li>
                                <li><a href="../classes/Programador.html">Programador</a></li>
                                <li><a href="../classes/Tarea.html">Tarea</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Arduinode.html">Arduinode</a></li>
                                <li><a href="../modules/DataStore.html">DataStore</a></li>
                                <li><a href="../modules/Programador de Tareas.html">Programador de Tareas</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: server.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
//Dependencias
var	express 			= require(&#x27;express&#x27;),
	app 				= express(),
	fs					= require(&#x27;fs&#x27;),
	compress 			= require(&#x27;compression&#x27;),
	http 				= require(&#x27;http&#x27;).Server(app),
	programadorTareas 	= require(&#x27;./programadorTareas&#x27;),
	expressConfig 		= require(&#x27;./config/config&#x27;).config(app, express),
	Arduinode			= require(&#x27;./Arduinode&#x27;);
	middleware 			= require(&#x27;socketio-wildcard&#x27;)(),
	io 					= require(&#x27;socket.io&#x27;)(http),
	require(&#x27;./controllers&#x27;)(app);
	app.use(compress());

var serverConfig = {},
	serverInfo	 = { host: &quot;localhost&quot;, port:8888 },
	configPath 	 = &#x27;./config/config.json&#x27;

//Crea o trae el archivo de configuracion para el servidor y Programador de tareas
if (!fs.existsSync(configPath))
{
	fs.writeFileSync(configPath, &#x27;{&quot;ip&quot;:&quot;localhost&quot;,&quot;port&quot;:8888, &quot;tiempoEscaneoTareas&quot;:300000}&#x27;);
}
var serverConfig = require(configPath);

/**
* Intenta ejecutar una tarea forzosamente. Comprobando si es valida,
* y el tiempo restante.
* @method forzarEjecucion
* @param tarea objeto tarea (instancia de Tarea)
* @return null
*/

//Server HTTP
http.listen(serverConfig.port, serverConfig.ip, function()
{
	console.log(&quot;Server iniciado en: &quot;, serverConfig.ip +&quot;:&quot;+serverConfig.port);

	//Captura excepciones para no detener el servidor
	process.on(&#x27;uncaughtException&#x27;, function (err)
	{
		console.log(&quot;Ocurrió un error:&quot;, err);
	});

	//Cargo lista de dispositivos en memoria
	Arduinode.dispositivos.load();

	//Carga lista de tareas en memoria
	programadorTareas.setConfig( serverConfig );
	programadorTareas.loadTareas();

	//Servicio que continua la ejecución de tareas en caso de falla
	programadorTareas.observarCambios();

	//Registra middleware para capturar requests y enviar la hora del server
	io.use(middleware);

	//Conexión de un cliente
	io.on(&#x27;connection&#x27;, function( sCliente )
	{
		//Seteo referencia al socket conectado
		app.sCliente = Arduinode.dispositivos.sCliente = sCliente;

		//Crea socket que recibe eventos de los disp. Arduino
		Arduinode.listenSwitchEvents( serverConfig );

		//Accion sobre una salida (Persiana, Luz, Bomba)
		sCliente.on(&#x27;accionarSalida&#x27;, function( params ) {
			Arduinode.dispositivos.accionar(params, function(response) {
				sCliente.emit(&#x27;accionarResponse&#x27;, response);
				sCliente.broadcast.emit(&#x27;switchBroadcast&#x27;, params);
			});
		});

		//Devuelve lista de salidas de un dispositivo (con sus estados)
		sCliente.on(&#x27;getSalidas&#x27;, function(params,p) {
			var action = &quot;get&quot; + params.page,
				onData = function(salidas) {
					sCliente.emit(&#x27;salidas&#x27;,salidas);
				};
			Arduinode.dispositivos[action](onData, params);
		});

		//Envia la hora del servidor en cada request Socket.IO
		sCliente.on(&#x27;*&#x27;, function() {
			sCliente.emit(&#x27;horaServidor&#x27;, new Date().getTime());
		});
	});
});
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
